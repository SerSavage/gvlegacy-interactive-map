<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gloria Victis Interactive Map</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #000; color: #fff; overflow: hidden; }
        .topmenu { background: #333; padding: 10px; text-align: center; z-index: 1000; position: relative; }
        .topmenu a { color: #fff; text-decoration: none; margin: 0 15px; }
        .topmenu a:hover { color: #ffff00; }
        #map-container { 
        width: 100%;
            height: calc(100vh - 50px); 
            background: #1a1a1a; 
            overflow: auto;
    position: relative;
        }
        #map-canvas {
      display: block;
            background: #1a1a1a;
        }
        .loading {
      position: absolute;
    top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
    color: #fff;
            font-size: 18px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="topmenu">
        <a href="#">Home</a>
        <a href="#">Interactive Map</a>
        <a href="#">Item Database</a>
        <a href="#">Workshop</a>
        <a href="#">Character Builder</a>
    </div>
    <div id="map-container">
        <div class="loading" id="loading">Loading map...</div>
        <canvas id="map-canvas"></canvas>
    </div>
    <script>
        console.log('=== Gloria Victis Interactive Map ===');
        
        var TILE_SIZE = 256;
        var areas = ['Main'];
        var loadingDiv = document.getElementById('loading');
        
        // Map coordinates: x0y0 to x20y17
        var minX = 0, maxX = 20;
        var minY = 0, maxY = 17;
        
        var canvas, ctx;
        var mapWidthPx, mapHeightPx;
        var loadedTiles = {};
        var loadingCount = 0;
        var totalToLoad = 0;
        var loadedCount = 0;
        var failedCount = 0;
        var drawnTiles = {}; // Track which tiles have been drawn
        
        function initializeMap() {
            var mapWidthTiles = maxX - minX + 1;  // 21
            var mapHeightTiles = maxY - minY + 1; // 18
            mapWidthPx = mapWidthTiles * TILE_SIZE;
            mapHeightPx = mapHeightTiles * TILE_SIZE;
            
            console.log('=== Map Setup ===');
            console.log('Tile range: X[' + minX + ' to ' + maxX + '], Y[' + minY + ' to ' + maxY + ']');
            console.log('Map size: ' + mapWidthTiles + 'x' + mapHeightTiles + ' tiles');
            console.log('Canvas size: ' + mapWidthPx + 'x' + mapHeightPx + ' pixels');
            
            canvas = document.getElementById('map-canvas');
            ctx = canvas.getContext('2d');
            
            canvas.width = mapWidthPx;
            canvas.height = mapHeightPx;
            
            // Fill background
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, mapWidthPx, mapHeightPx);
            
            // Start loading tiles
            loadAllTiles();
            
            setupControls();
            
            // Center view
            var container = document.getElementById('map-container');
            container.scrollLeft = mapWidthPx / 2 - container.clientWidth / 2;
            container.scrollTop = mapHeightPx / 2 - container.clientHeight / 2;
        }
        
        function loadAllTiles() {
            var tilesToLoad = [];
            
            // Load tiles in order: row by row, left to right
            for (var y = minY; y <= maxY; y++) {
                for (var x = minX; x <= maxX; x++) {
                    areas.forEach(function(area) {
                        tilesToLoad.push({x: x, y: y, area: area});
                    });
                }
            }
            
            totalToLoad = tilesToLoad.length;
            console.log('Total tiles to load: ' + totalToLoad);
            console.log('First tile: x' + tilesToLoad[0].x + 'y' + tilesToLoad[0].y);
            console.log('Last tile: x' + tilesToLoad[tilesToLoad.length - 1].x + 'y' + tilesToLoad[tilesToLoad.length - 1].y);
            
            // Load all tiles - ensure proper order
            tilesToLoad.forEach(function(tile, index) {
                setTimeout(function() {
                    loadTile(tile.x, tile.y, tile.area, false);
                }, index * 2);
            });
        }
        
        function loadTile(x, y, area, debug) {
            var key = x + ',' + y + ',' + area;
            
            if (loadedTiles[key] !== undefined) return;
            
            loadingCount++;
            var img = new Image();
            var tilePath = '/GVmaptiles/x' + x + 'y' + y + '_' + area + '.png';
            
            img.onload = function() {
                loadedTiles[key] = img;
                loadingCount--;
                loadedCount++;
                
                // Y axis inverted: y0 at bottom, y17 at top
                var px = x * TILE_SIZE;
                var py = (maxY - y) * TILE_SIZE;
                
                // Ensure we don't draw outside canvas
                if (px >= 0 && px < mapWidthPx && py >= 0 && py < mapHeightPx) {
                    // Draw tile directly - no need to clear, tiles should fit perfectly
                    ctx.drawImage(img, px, py);
                    drawnTiles[key] = true;
                } else {
                    console.error('Tile x' + x + 'y' + y + ' OUT OF BOUNDS at [' + px + ', ' + py + '] (canvas: ' + mapWidthPx + 'x' + mapHeightPx + ')');
                }
                
                updateProgress();
            };
            
            img.onerror = function() {
                loadedTiles[key] = null;
                loadingCount--;
                failedCount++;
                
                if (debug) {
                    console.warn('Failed to load: ' + tilePath);
                }
                
                updateProgress();
            };
            
            img.src = tilePath;
        }
        
        function updateProgress() {
            var total = loadedCount + failedCount;
            var percent = Math.round((total / totalToLoad) * 100);
            
            loadingDiv.textContent = 'Loading: ' + percent + '% (' + loadedCount + ' loaded, ' + failedCount + ' missing)';
            
            if (total >= totalToLoad && loadingCount === 0) {
                loadingDiv.style.display = 'none';
                console.log('=== Loading Complete ===');
                console.log('Successfully loaded: ' + loadedCount + ' tiles');
                console.log('Failed to load: ' + failedCount + ' tiles');
                console.log('Tiles drawn: ' + Object.keys(drawnTiles).length);
                console.log('Canvas size: ' + canvas.width + 'x' + canvas.height);
                
                // Check for missing tiles
                var expectedTiles = (maxX - minX + 1) * (maxY - minY + 1);
                console.log('Expected tiles: ' + expectedTiles);
                
                if (loadedCount < expectedTiles) {
                    console.warn('MISSING TILES: Expected ' + expectedTiles + ' but only loaded ' + loadedCount);
                }
                
                // Check if all positions have tiles
                var missingPositions = [];
                for (var y = minY; y <= maxY; y++) {
                    for (var x = minX; x <= maxX; x++) {
                        var key = x + ',' + y + ',Main';
                        if (!drawnTiles[key]) {
                            missingPositions.push('x' + x + 'y' + y);
                        }
                    }
                }
                if (missingPositions.length > 0) {
                    console.warn('Missing tile positions: ' + missingPositions.slice(0, 20).join(', ') + (missingPositions.length > 20 ? '...' : ''));
                } else {
                    console.log('All tile positions have been drawn!');
                }
            }
        }
        
        function setupControls() {
            var scale = 1;
            var container = document.getElementById('map-container');
            
            container.addEventListener('wheel', function(e) {
                e.preventDefault();
                var delta = e.deltaY > 0 ? 0.9 : 1.1;
                scale = Math.max(0.5, Math.min(3, scale * delta));
                canvas.style.transform = 'scale(' + scale + ')';
                canvas.style.transformOrigin = 'top left';
            });
            
            var isDragging = false;
            var startX, startY, scrollLeft, scrollTop;
            
            container.addEventListener('mousedown', function(e) {
                isDragging = true;
                startX = e.pageX - container.offsetLeft;
                startY = e.pageY - container.offsetTop;
                scrollLeft = container.scrollLeft;
                scrollTop = container.scrollTop;
            });
            
            container.addEventListener('mouseleave', function() {
                isDragging = false;
            });
            
            container.addEventListener('mouseup', function() {
                isDragging = false;
            });
            
            container.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                e.preventDefault();
                var x = e.pageX - container.offsetLeft;
                var y = e.pageY - container.offsetTop;
                var walkX = (x - startX) * 2;
                var walkY = (y - startY) * 2;
                container.scrollLeft = scrollLeft - walkX;
                container.scrollTop = scrollTop - walkY;
            });
        }
        
        initializeMap();
        console.log('Map initialized');
    </script>
  </body>
</html>
