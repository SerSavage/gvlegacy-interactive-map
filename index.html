<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gloria Victis Interactive Map</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #000; color: #fff; overflow: hidden; }
        .topmenu { background: #333; padding: 10px; text-align: center; z-index: 1000; position: relative; }
        .topmenu a { color: #fff; text-decoration: none; margin: 0 15px; }
        .topmenu a:hover { color: #ffff00; }
        #map-container { 
            width: 100%; 
            height: calc(100vh - 50px); 
            background: #1a1a1a; 
            overflow: auto;
            position: relative;
        }
        #map-canvas {
            display: block;
            background: #1a1a1a;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 18px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="topmenu">
        <a href="#">Home</a>
        <a href="#">Interactive Map</a>
        <a href="#">Item Database</a>
        <a href="#">Workshop</a>
        <a href="#">Character Builder</a>
    </div>
    <div id="map-container">
        <div class="loading" id="loading">Initializing map...</div>
        <canvas id="map-canvas"></canvas>
    </div>
    <script>
        console.log('=== Gloria Victis Interactive Map (Lazy Loading) ===');
        
        var TILE_SIZE = 256;
        var areas = ['Main', 'GC1', 'ArenaTournament'];
        var loadingDiv = document.getElementById('loading');
        
        // Stoneholm map coordinates: x0y0 to x20y17
        var minX = 0, maxX = 20;
        var minY = 0, maxY = 17;
        
        // Track loaded tiles
        var loadedTiles = {}; // key: "x,y,area" -> Image object
        var loadingTiles = {}; // key: "x,y,area" -> true if loading
        
        var canvas, ctx;
        var mapWidthPx, mapHeightPx;
        
        function initializeMap() {
            // Calculate map dimensions
            var mapWidthTiles = maxX - minX + 1;  // 21 tiles (0-20)
            var mapHeightTiles = maxY - minY + 1; // 18 tiles (0-17)
            mapWidthPx = mapWidthTiles * TILE_SIZE;  // 21 * 256 = 5376px
            mapHeightPx = mapHeightTiles * TILE_SIZE; // 18 * 256 = 4608px
            
            console.log('=== Map Initialization ===');
            console.log('Tile range: X[' + minX + ' to ' + maxX + '] (' + mapWidthTiles + ' tiles)');
            console.log('Tile range: Y[' + minY + ' to ' + maxY + '] (' + mapHeightTiles + ' tiles)');
            console.log('Canvas size: ' + mapWidthPx + 'x' + mapHeightPx + ' pixels');
            
            canvas = document.getElementById('map-canvas');
            ctx = canvas.getContext('2d');
            
            canvas.width = mapWidthPx;
            canvas.height = mapHeightPx;
            
            console.log('Canvas dimensions: ' + canvas.width + 'x' + canvas.height);
            
            // Fill background
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, mapWidthPx, mapHeightPx);
            
            loadingDiv.style.display = 'none';
            
            // Load initial viewport tiles
            loadVisibleTiles();
            
            // Setup scroll listener to load tiles as user pans
            var container = document.getElementById('map-container');
            var scrollTimeout;
            container.addEventListener('scroll', function() {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(loadVisibleTiles, 100);
            });
            
            setupControls(canvas);
            
            // Center view
            container.scrollLeft = mapWidthPx / 2 - container.clientWidth / 2;
            container.scrollTop = mapHeightPx / 2 - container.clientHeight / 2;
            
            console.log('Map initialized - lazy loading enabled');
        }
        
        // Get visible tile range based on viewport
        function getVisibleTileRange() {
            var container = document.getElementById('map-container');
            var scrollLeft = container.scrollLeft;
            var scrollTop = container.scrollTop;
            var viewWidth = container.clientWidth;
            var viewHeight = container.clientHeight;
            
            // Add padding to load tiles slightly outside viewport
            var padding = 512; // 2 tiles worth
            
            var startX = Math.max(minX, Math.floor((scrollLeft - padding) / TILE_SIZE));
            var endX = Math.min(maxX, Math.floor((scrollLeft + viewWidth + padding) / TILE_SIZE));
            var startY = Math.max(minY, Math.floor((scrollTop - padding) / TILE_SIZE));
            var endY = Math.min(maxY, Math.floor((scrollTop + viewHeight + padding) / TILE_SIZE));
            
            return {
                startX: startX,
                endX: endX,
                startY: startY,
                endY: endY
            };
        }
        
        // Load tiles visible in viewport
        function loadVisibleTiles() {
            var range = getVisibleTileRange();
            var tilesToLoad = [];
            var tilesLoaded = 0;
            
            // Check which tiles need to be loaded
            for (var y = range.startY; y <= range.endY; y++) {
                for (var x = range.startX; x <= range.endX; x++) {
                    areas.forEach(function(area) {
                        var key = x + ',' + y + ',' + area;
                        
                        if (!loadedTiles[key] && !loadingTiles[key]) {
                            tilesToLoad.push({x: x, y: y, area: area, key: key});
                        } else if (loadedTiles[key]) {
                            tilesLoaded++;
                        }
                    });
                }
            }
            
            if (tilesToLoad.length > 0) {
                console.log('Loading ' + tilesToLoad.length + ' visible tiles (viewport: ' + range.startX + ',' + range.startY + ' to ' + range.endX + ',' + range.endY + ')');
                
                // Update loading message
                if (tilesLoaded === 0 && tilesToLoad.length > 10) {
                    loadingDiv.style.display = 'block';
                    loadingDiv.textContent = 'Loading visible tiles... ' + tilesToLoad.length;
                }
            }
            
            // Load tiles in small batches
            var batchSize = 5;
            var currentIndex = 0;
            
            function loadBatch() {
                var end = Math.min(currentIndex + batchSize, tilesToLoad.length);
                
                for (var i = currentIndex; i < end; i++) {
                    var tile = tilesToLoad[i];
                    loadTile(tile.x, tile.y, tile.area, tile.key);
                }
                
                currentIndex = end;
                
                if (end < tilesToLoad.length) {
                    setTimeout(loadBatch, 50);
                } else {
                    loadingDiv.style.display = 'none';
                }
            }
            
            if (tilesToLoad.length > 0) {
                loadBatch();
            } else {
                loadingDiv.style.display = 'none';
            }
        }
        
        // Load a single tile
        function loadTile(x, y, area, key) {
            if (loadingTiles[key]) return; // Already loading
            
            loadingTiles[key] = true;
            var img = new Image();
            var tilePath = '/GVmaptiles/x' + x + 'y' + y + '_' + area + '.png';
            
            img.onload = function() {
                loadedTiles[key] = img;
                delete loadingTiles[key];
                
                // Draw the tile at correct position
                var px = (x - minX) * TILE_SIZE; // x * 256 (since minX = 0)
                var py = (y - minY) * TILE_SIZE; // y * 256 (since minY = 0)
                
                ctx.drawImage(img, px, py);
            };
            
            img.onerror = function() {
                // Tile doesn't exist - mark as loaded (null) so we don't keep trying
                loadedTiles[key] = null;
                delete loadingTiles[key];
            };
            
            img.src = tilePath;
        }
        
        function setupControls(canvas) {
            var scale = 1;
            var container = document.getElementById('map-container');
            
            // Zoom with mouse wheel
            container.addEventListener('wheel', function(e) {
                e.preventDefault();
                var delta = e.deltaY > 0 ? 0.9 : 1.1;
                scale = Math.max(0.5, Math.min(3, scale * delta));
                canvas.style.transform = 'scale(' + scale + ')';
                canvas.style.transformOrigin = 'top left';
                
                // Load tiles for new zoom level
                setTimeout(loadVisibleTiles, 100);
            });
            
            // Pan with mouse drag
            var isDragging = false;
            var startX, startY, scrollLeft, scrollTop;
            
            container.addEventListener('mousedown', function(e) {
                isDragging = true;
                startX = e.pageX - container.offsetLeft;
                startY = e.pageY - container.offsetTop;
                scrollLeft = container.scrollLeft;
                scrollTop = container.scrollTop;
            });
            
            container.addEventListener('mouseleave', function() {
                isDragging = false;
            });
            
            container.addEventListener('mouseup', function() {
                isDragging = false;
            });
            
            container.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                e.preventDefault();
                var x = e.pageX - container.offsetLeft;
                var y = e.pageY - container.offsetTop;
                var walkX = (x - startX) * 2;
                var walkY = (y - startY) * 2;
                container.scrollLeft = scrollLeft - walkX;
                container.scrollTop = scrollTop - walkY;
            });
        }
        
        // Initialize
        initializeMap();
        console.log('=== Map Initialized (Lazy Loading) ===');
    </script>
</body>
</html>
