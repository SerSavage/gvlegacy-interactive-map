<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gloria Victis Interactive Map</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #000; color: #fff; overflow: hidden; }
        .topmenu { background: #333; padding: 10px; text-align: center; z-index: 1000; position: relative; }
        .topmenu a { color: #fff; text-decoration: none; margin: 0 15px; }
        .topmenu a:hover { color: #ffff00; }
        #map-container { 
            width: 100%; 
            height: calc(100vh - 50px); 
            background: #1a1a1a; 
            overflow: auto;
            position: relative;
        }
        #map-canvas {
            display: block;
            background: #1a1a1a;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 18px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="topmenu">
        <a href="#">Home</a>
        <a href="#">Interactive Map</a>
        <a href="#">Item Database</a>
        <a href="#">Workshop</a>
        <a href="#">Character Builder</a>
    </div>
    <div id="map-container">
        <div class="loading" id="loading">Loading map tiles...</div>
        <canvas id="map-canvas"></canvas>
    </div>
    <script>
        console.log('=== Gloria Victis Interactive Map ===');
        
        var TILE_SIZE = 256;
        var areas = ['Main', 'GC1', 'ArenaTournament'];
        var loadingDiv = document.getElementById('loading');
        
        // Discover coordinates
        var tileCoords = new Set();
        var minX = Infinity, maxX = -Infinity;
        var minY = Infinity, maxY = -Infinity;
        var discoveredTiles = {};
        var imagesLoaded = 0;
        var imagesTested = 0;
        
        // Test if a tile exists by loading it
        function testTile(x, y, area, callback) {
            var img = new Image();
            var tilePath = '/GVmaptiles/x' + x + 'y' + y + '_' + area + '.png';
            
            img.onload = function() {
                var key = x + ',' + y;
                if (!tileCoords.has(key)) {
                    tileCoords.add(key);
                    minX = Math.min(minX, x);
                    maxX = Math.max(maxX, x);
                    minY = Math.min(minY, y);
                    maxY = Math.max(maxY, y);
                }
                if (!discoveredTiles[key]) {
                    discoveredTiles[key] = [];
                }
                discoveredTiles[key].push(area);
                imagesLoaded++;
                callback(true);
            };
            
            img.onerror = function() {
                callback(false);
            };
            
            img.src = tilePath;
        }
        
        // Discover tiles in a range
        function discoverTiles() {
            loadingDiv.textContent = 'Discovering map tiles...';
            
            // Test range: -5 to 25 (should cover all tiles)
            var testRangeX = {min: -5, max: 25};
            var testRangeY = {min: -5, max: 25};
            
            var allTests = [];
            for (var y = testRangeY.min; y <= testRangeY.max; y++) {
                for (var x = testRangeX.min; x <= testRangeX.max; x++) {
                    areas.forEach(function(area) {
                        allTests.push({x: x, y: y, area: area});
                    });
                }
            }
            
            var totalTests = allTests.length;
            var completed = 0;
            var batchSize = 20;
            var currentIndex = 0;
            
            function processBatch() {
                var end = Math.min(currentIndex + batchSize, allTests.length);
                
                for (var i = currentIndex; i < end; i++) {
                    var test = allTests[i];
                    testTile(test.x, test.y, test.area, function(success) {
                        completed++;
                        var percent = Math.round((completed / totalTests) * 100);
                        loadingDiv.textContent = 'Discovering map tiles... ' + percent + '% (' + imagesLoaded + ' found)';
                        
                        if (completed >= totalTests) {
                            // Wait a bit for any pending loads
                            setTimeout(function() {
                                console.log('Discovery complete!');
                                console.log('X range: ' + minX + ' to ' + maxX);
                                console.log('Y range: ' + minY + ' to ' + maxY);
                                console.log('Found ' + tileCoords.size + ' unique tile positions');
                                console.log('Total images loaded: ' + imagesLoaded);
                                
                                if (tileCoords.size === 0) {
                                    console.warn('No tiles found! Trying fallback...');
                                    // Fallback: try known coordinates
                                    tryKnownCoordinates();
                                } else {
                                    initializeMap();
                                }
                            }, 1000);
                        }
                    });
                }
                
                currentIndex = end;
                if (end < allTests.length) {
                    setTimeout(processBatch, 10);
                }
            }
            
            processBatch();
        }
        
        // Fallback: try known coordinate ranges
        function tryKnownCoordinates() {
            console.log('Trying fallback coordinates...');
            loadingDiv.textContent = 'Trying fallback coordinates...';
            
            // Based on earlier checks, tiles are 0-20 for X, 0-17 for Y
            var fallbackTests = [];
            for (var y = 0; y <= 17; y++) {
                for (var x = 0; x <= 20; x++) {
                    areas.forEach(function(area) {
                        fallbackTests.push({x: x, y: y, area: area});
                    });
                }
            }
            
            var completed = 0;
            var total = fallbackTests.length;
            
            fallbackTests.forEach(function(test) {
                testTile(test.x, test.y, test.area, function(success) {
                    completed++;
                    if (completed >= total) {
                        setTimeout(function() {
                            if (tileCoords.size > 0) {
                                console.log('Fallback found tiles!');
                                initializeMap();
                            } else {
                                console.error('Fallback also failed!');
                                loadingDiv.textContent = 'Error: Could not load map tiles. Check browser console.';
                            }
                        }, 500);
                    }
                });
            });
        }
        
        function initializeMap() {
            if (minX === Infinity || maxX === -Infinity || tileCoords.size === 0) {
                console.error('No tiles discovered!');
                loadingDiv.textContent = 'Error: No map tiles found';
                return;
            }
            
            // Calculate map dimensions
            var mapWidthTiles = maxX - minX + 1;
            var mapHeightTiles = maxY - minY + 1;
            var mapWidthPx = mapWidthTiles * TILE_SIZE;
            var mapHeightPx = mapHeightTiles * TILE_SIZE;
            
            console.log('Map dimensions: ' + mapWidthTiles + 'x' + mapHeightTiles + ' tiles');
            console.log('Pixel dimensions: ' + mapWidthPx + 'x' + mapHeightPx);
            console.log('Offset: X=' + minX + ', Y=' + minY);
            
            var canvas = document.getElementById('map-canvas');
            var ctx = canvas.getContext('2d');
            
            canvas.width = mapWidthPx;
            canvas.height = mapHeightPx;
            
            // Fill background
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, mapWidthPx, mapHeightPx);
            
            var loadedTiles = 0;
            var failedTiles = 0;
            var allLoaded = 0;
            
            // Count total tiles to load
            var totalToLoad = 0;
            tileCoords.forEach(function(coordKey) {
                var existingAreas = discoveredTiles[coordKey] || [];
                totalToLoad += existingAreas.length;
            });
            
            console.log('Total tiles to load: ' + totalToLoad);
            
            if (totalToLoad === 0) {
                console.error('No tiles to load!');
                loadingDiv.textContent = 'Error: No tiles found';
                return;
            }
            
            // Load all discovered tiles
            function loadTile(x, y, area, callback) {
                var img = new Image();
                var tilePath = '/GVmaptiles/x' + x + 'y' + y + '_' + area + '.png';
                
                img.onload = function() {
                    var px = (x - minX) * TILE_SIZE;
                    var py = (y - minY) * TILE_SIZE;
                    ctx.drawImage(img, px, py);
                    callback(true);
                };
                
                img.onerror = function() {
                    console.warn('Failed to load: ' + tilePath);
                    callback(false);
                };
                
                img.src = tilePath;
            }
            
            // Load tiles for each discovered coordinate
            tileCoords.forEach(function(coordKey) {
                var parts = coordKey.split(',');
                var x = parseInt(parts[0]);
                var y = parseInt(parts[1]);
                
                var existingAreas = discoveredTiles[coordKey] || [];
                existingAreas.forEach(function(area) {
                    loadTile(x, y, area, function(success) {
                        allLoaded++;
                        if (success) {
                            loadedTiles++;
                        } else {
                            failedTiles++;
                        }
                        
                        var percent = Math.round((allLoaded / totalToLoad) * 100);
                        loadingDiv.textContent = 'Loading map tiles... ' + percent + '% (' + loadedTiles + ' loaded)';
                        
                        if (allLoaded >= totalToLoad) {
                            loadingDiv.style.display = 'none';
                            console.log('Map loaded! ' + loadedTiles + ' tiles loaded, ' + failedTiles + ' missing');
                            console.log('Map is ready!');
                            
                            // Center the view
                            var container = document.getElementById('map-container');
                            container.scrollLeft = (mapWidthPx - container.clientWidth) / 2;
                            container.scrollTop = (mapHeightPx - container.clientHeight) / 2;
                        }
                    });
                });
            });
            
            setupControls(canvas);
        }
        
        function setupControls(canvas) {
            var scale = 1;
            var container = document.getElementById('map-container');
            
            container.addEventListener('wheel', function(e) {
                e.preventDefault();
                var delta = e.deltaY > 0 ? 0.9 : 1.1;
                scale = Math.max(0.5, Math.min(3, scale * delta));
                canvas.style.transform = 'scale(' + scale + ')';
                canvas.style.transformOrigin = 'top left';
            });
            
            var isDragging = false;
            var startX, startY, scrollLeft, scrollTop;
            
            container.addEventListener('mousedown', function(e) {
                isDragging = true;
                startX = e.pageX - container.offsetLeft;
                startY = e.pageY - container.offsetTop;
                scrollLeft = container.scrollLeft;
                scrollTop = container.scrollTop;
            });
            
            container.addEventListener('mouseleave', function() {
                isDragging = false;
            });
            
            container.addEventListener('mouseup', function() {
                isDragging = false;
            });
            
            container.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                e.preventDefault();
                var x = e.pageX - container.offsetLeft;
                var y = e.pageY - container.offsetTop;
                var walkX = (x - startX) * 2;
                var walkY = (y - startY) * 2;
                container.scrollLeft = scrollLeft - walkX;
                container.scrollTop = scrollTop - walkY;
            });
        }
        
        // Start discovery
        discoverTiles();
        console.log('=== Map Initialized ===');
    </script>
</body>
</html>
