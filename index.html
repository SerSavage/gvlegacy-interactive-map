<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gloria Victis Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #000; color: #fff; overflow: hidden; }
        .topmenu { background: #333; padding: 10px; text-align: center; z-index: 1000; position: relative; }
        .topmenu a { color: #fff; text-decoration: none; margin: 0 15px; }
        .topmenu a:hover { color: #ffff00; }
        #gv-map { width: 100%; height: calc(100vh - 50px); background: #1a1a1a; }
    </style>
</head>
<body>
    <div class="topmenu">
        <a href="#">Home</a>
        <a href="#">Interactive Map</a>
        <a href="#">Item Database</a>
        <a href="#">Workshop</a>
        <a href="#">Character Builder</a>
    </div>
    <div id="gv-map"></div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        console.log('=== Gloria Victis Map Initialization ===');
        
        var TILE_SIZE = 256;
        var MAP_WIDTH_TILES = 21;
        var MAP_HEIGHT_TILES = 18;
        var MAP_WIDTH_PX = MAP_WIDTH_TILES * TILE_SIZE;
        var MAP_HEIGHT_PX = MAP_HEIGHT_TILES * TILE_SIZE;
        
        console.log('Map dimensions: ' + MAP_WIDTH_TILES + 'x' + MAP_HEIGHT_TILES + ' tiles');
        console.log('Pixel dimensions: ' + MAP_WIDTH_PX + 'x' + MAP_HEIGHT_PX);
        
        var map = L.map('gv-map', {
            crs: L.CRS.Simple,
            minZoom: 0,
            maxZoom: 2
        });
        
        // Custom tile layer
        var GVTileLayer = L.TileLayer.extend({
            initialize: function(options) {
                this.areas = ['Main', 'GC1', 'ArenaTournament'];
                L.TileLayer.prototype.initialize.call(this, '', options);
            },
            
            createTile: function(coords, done) {
                var tile = document.createElement('canvas');
                tile.width = TILE_SIZE;
                tile.height = TILE_SIZE;
                var ctx = tile.getContext('2d');
                
                // Fill with dark background first
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(0, 0, TILE_SIZE, TILE_SIZE);
                
                // Calculate tile coordinates
                var tileX = Math.floor(coords.x / TILE_SIZE);
                var tileY = Math.floor(coords.y / TILE_SIZE);
                
                // Validate
                if (tileX < 0 || tileX >= MAP_WIDTH_TILES || tileY < 0 || tileY >= MAP_HEIGHT_TILES) {
                    done(null, tile);
                    return tile;
                }
                
                var areas = this.areas;
                var loaded = 0;
                var total = areas.length;
                var hasAnyImage = false;
                
                var checkComplete = function() {
                    loaded++;
                    if (loaded >= total) {
                        if (!hasAnyImage) {
                            // Draw a small indicator if no tiles found
                            ctx.fillStyle = '#333';
                            ctx.fillRect(0, 0, TILE_SIZE, TILE_SIZE);
                            ctx.fillStyle = '#666';
                            ctx.font = '12px Arial';
                            ctx.fillText('x' + tileX + 'y' + tileY, 10, 20);
                        }
                        done(null, tile);
                    }
                };
                
                // Load tiles
                areas.forEach(function(area) {
                    var img = new Image();
                    var tilePath = 'GVmaptiles/x' + tileX + 'y' + tileY + '_' + area + '.png';
                    
                    img.onload = function() {
                        console.log('âœ“ Loaded: ' + tilePath);
                        ctx.drawImage(img, 0, 0);
                        hasAnyImage = true;
                        checkComplete();
                    };
                    
                    img.onerror = function() {
                        // Tile doesn't exist for this area
                        checkComplete();
                    };
                    
                    // Try loading the tile
                    img.src = tilePath;
                });
                
                return tile;
            }
        });
        
        var mapLayer = new GVTileLayer({
            minZoom: 0,
            maxZoom: 2,
            tileSize: TILE_SIZE,
            noWrap: true,
            attribution: 'Gloria Victis Map'
        });
        
        mapLayer.addTo(map);
        
        // Set view to center
        var centerY = MAP_HEIGHT_PX / 2;
        var centerX = MAP_WIDTH_PX / 2;
        map.setView([centerY, centerX], 0);
        
        // Set bounds
        map.setMaxBounds(L.latLngBounds([0, 0], [MAP_HEIGHT_PX, MAP_WIDTH_PX]));
        
        console.log('Map view set to center: [' + centerY + ', ' + centerX + ']');
        console.log('=== Map Initialized ===');
        console.log('Open browser console (F12) to see tile loading messages');
    </script>
</body>
</html>
